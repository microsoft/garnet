"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[7032],{21348(e,n,o){o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"dev/collection-broker","title":"Collection Broker","description":"The role of the collection broker is to facilitate blocking commands on collections in Garnet.\\\\","source":"@site/docs/dev/collection-broker.md","sourceDirName":"dev","slug":"/dev/collection-broker","permalink":"/garnet/docs/dev/collection-broker","draft":false,"unlisted":false,"editUrl":"https://github.com/microsoft/garnet/tree/main/website/docs/dev/collection-broker.md","tags":[],"version":"current","frontMatter":{"id":"collection-broker","sidebar_label":"Collection Broker","title":"Collection Broker","slug":"collection-broker"},"sidebar":"garnetDocSidebar","previous":{"title":"Logical Databases","permalink":"/garnet/docs/dev/multi-db"},"next":{"title":"Cluster Overview","permalink":"/garnet/docs/dev/cluster/overview"}}');var t=o(74848),s=o(28453);const l={id:"collection-broker",sidebar_label:"Collection Broker",title:"Collection Broker",slug:"collection-broker"},r=void 0,c={},a=[{value:"Logical Flow",id:"logical-flow",level:3},{value:"Incoming blocking command:",id:"incoming-blocking-command",level:4},{value:"Incoming &quot;releasing&quot; command:",id:"incoming-releasing-command",level:4},{value:"Main broker loop:",id:"main-broker-loop",level:4},{value:"Disposed sessions:",id:"disposed-sessions",level:4}];function d(e){const n={a:"a",br:"br",code:"code",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["The role of the collection broker is to facilitate blocking commands on collections in Garnet.",(0,t.jsx)(n.br,{}),"\n","A blocking command is a command that returns immediately if an item in a collection is available or blocks the client until an item is avilable (see: ",(0,t.jsx)(n.a,{href:"/garnet/docs/commands/data-structures#blpop",children:"BLPOP"}),", ",(0,t.jsx)(n.a,{href:"/garnet/docs/commands/data-structures#blmove",children:"BLMOVE"})," etc).",(0,t.jsx)(n.br,{}),"\n","The broker runs its main loop on a dedicated Task whenever there are active clients waiting on collection items."]}),"\n",(0,t.jsx)(n.h3,{id:"logical-flow",children:"Logical Flow"}),"\n",(0,t.jsx)(n.h4,{id:"incoming-blocking-command",children:"Incoming blocking command:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["A client sends a blocking command, the command handler in turn calls ",(0,t.jsx)(n.code,{children:"CollectionItemBroker.GetCollectionItemAsync"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["If the broker's main loop is not running, it will start running and wait on the next event in its event queue (",(0,t.jsx)(n.code,{children:"brokerEventsQueue"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:["A new ",(0,t.jsx)(n.code,{children:"CollectionItemObserver"})," object is created and an event of type ",(0,t.jsx)(n.code,{children:"NewObserverEvent"})," is pushed into the event queue."]}),"\n",(0,t.jsxs)(n.li,{children:["The command handler awaits on one of two occurrences:","\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"A semaphore signal coming from the main loop to notify an item has been found."}),"\n",(0,t.jsx)(n.li,{children:"A timeout specified by the client has been reached."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"incoming-releasing-command",children:'Incoming "releasing" command:'}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["A client inserts an item into a collection the command handler in turn calls ",(0,t.jsx)(n.code,{children:"CollectionItemBroker.HandleCollectionUpdate"}),"\\","\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"If the collection is not observed by and clients, nothing to do."}),"\n",(0,t.jsxs)(n.li,{children:["Otherwise, a new event of type ",(0,t.jsx)(n.code,{children:"CollectionUpdatedEvent"})," is pushed into the event queue."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"main-broker-loop",children:"Main broker loop:"}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["The main loop (",(0,t.jsx)(n.code,{children:"CollectionItemBroker.Start"}),") continuously listens on an ",(0,t.jsx)(n.code,{children:"AsyncQueue"})," for new incoming events and synchronously calls ",(0,t.jsx)(n.code,{children:"HandleBrokerEvent"})," for each new event.\\","\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["For events of type ",(0,t.jsx)(n.code,{children:"NewObserverEvent"}),", ",(0,t.jsx)(n.code,{children:"InitializeObserver"})," is called. ",(0,t.jsx)(n.code,{children:"InitializeObserver"})," takes an array of keys and checks the collection values for available item in the order in which they where specified by the client.\nIf an item is found, the observer is updated which sets the result and signals the semaphore to release the awaiting thread. If no item is found, the observer is being added to each key's observer queue."]}),"\n",(0,t.jsxs)(n.li,{children:["For events of type ",(0,t.jsx)(n.code,{children:"CollectionUpdatedEvent"}),", ",(0,t.jsx)(n.code,{children:"TryAssignItemFromKey"})," is called. This method gets the key's observer queue and tries to assign the next available item from the collection stored at key to the next observer.\nIf an available item was indeed found, the observer is updated which sets the result and signals the semaphore to release the awaiting thread."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"disposed-sessions",children:"Disposed sessions:"}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsxs)(n.li,{children:["If a ",(0,t.jsx)(n.code,{children:"RespServerSession"})," that has an active observer is disposed, its ",(0,t.jsx)(n.code,{children:"Dispose"})," method will call ",(0,t.jsx)(n.code,{children:"CollectionItemBroker.HandleSessionDisposed"}),", which in turn will update the observer and signal the semaphore awaiter to stop. Once the observer's status is changed to ",(0,t.jsx)(n.code,{children:"SessionDisposed"}),", the main loop will not assign it any item."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453(e,n,o){o.d(n,{R:()=>l,x:()=>r});var i=o(96540);const t={},s=i.createContext(t);function l(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);