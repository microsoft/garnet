<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://microsoft.github.io/garnet/blog</id>
    <title>Garnet Blog</title>
    <updated>2025-01-18T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://microsoft.github.io/garnet/blog"/>
    <subtitle>Garnet Blog</subtitle>
    <icon>https://microsoft.github.io/garnet/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[ETags, When and How]]></title>
        <id>https://microsoft.github.io/garnet/blog/etags-when-and-how</id>
        <link href="https://microsoft.github.io/garnet/blog/etags-when-and-how"/>
        <updated>2025-01-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Garnet recently announced native support for ETag-based commands.]]></summary>
        <content type="html"><![CDATA[<p><strong>Garnet recently announced native support for ETag-based commands.</strong></p>
<p>Native ETags in a cache-store enable real-world use cases such as maintaining cache consistency, reducing network bandwidth utilization, and avoiding full-blown transactions for several applications.</p>
<p>Garnet provides native ETag support for raw strings (data added and retrieved using operations such as <code>GET</code> and <code>SET</code>). It is not available for objects (such as sorted-set, hash, list). This feature is available without requiring any migration, allowing your existing key-value pairs to start leveraging ETags immediately. You can find the ETag API documentation <a href="https://microsoft.github.io/garnet/docs/commands/garnet-specific-commands#native-etag-support">here</a>.</p>
<p>This article explores when and how you can use this new Garnet feature for both your current and future applications.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-read-this-article">Why Read This Article?<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#why-read-this-article" class="hash-link" aria-label="Direct link to Why Read This Article?" title="Direct link to Why Read This Article?" translate="no">​</a></h2>
<p>If you're looking to:</p>
<ol>
<li><strong>Keep your cache consistent with your back-end database</strong></li>
<li><strong>Reduce network bandwidth utilization for caching.</strong></li>
<li><strong>Atomically updating cached records based on client-side update logic.</strong></li>
</ol>
<p>We'll cover these scenarios one by one below.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="keeping-the-cache-consistent-with-its-back-end-database">Keeping the Cache Consistent with its Back-end Database<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#keeping-the-cache-consistent-with-its-back-end-database" class="hash-link" aria-label="Direct link to Keeping the Cache Consistent with its Back-end Database" title="Direct link to Keeping the Cache Consistent with its Back-end Database" translate="no">​</a></h2>
<p>In a distributed environment it is common to have a cache in front of your main <em>source of truth</em> database. Typically, multiple client applications access the cache and the database at the same time. If every client were to access a different set of keys, the caches can easily be maintained consistenty: a client simply writes to the database and then updates the cache.</p>
<p>However, in cases where a key can be updated by multiple clients, the naive approach of first updating the database and then updating the cache can lead to subtle race conditions. Specifically, whichever client writes to the cache last determines the final state of the cache. This cached state may not ever correspond to the final state of the database for the same key!</p>
<p>To make the above scenario clearer, consider a cache-database setup where 2 clients are interacting with the pair. They both follow the same protocol where on writes they first update the database, and then update the cache. We will denote each client by c1 and c2, the request to update the datbase as D, and the request to update the cache as C.</p>
<p>All is good for sequences where the last writer to the database is also the last writer to the cache:</p>
<!-- -->
<p>However, if the last writer to the database is NOT the last writer to the case, we introduce a <em>permanent</em> inconsistency between the cache and the database, as the following diagram depicts:</p>
<!-- -->
<p>In the above sequencing, note that c2 performs the last write to the database. However, c1 performs the last write to the cache. As a result, the cache and the database have gone out of sync.</p>
<p>For handling such cases we can rely on the newly introduced ETag feature in Garnet to construct a logical clock around the updates that protect establishing cache consistency (*provided your database also supports ETags or some other form of server-side transactions).</p>
<p>In such a scenario the client should use our <code>SETIFGREATER</code> API <a href="https://microsoft.github.io/garnet/docs/commands/garnet-specific-commands#setifgreater">here</a>, when interacting with the cache. <code>SETIFGREATER</code> sends a key-value pair along with an etag from the client, and only sets the value if the sent ETag is greater than what is currently set in the cache for that key-value pair.</p>
<p>Every client would now follow the following protocol:</p>
<ul>
<li>Database stores a pair of (value, etag) on the server</li>
<li>Use a transaction (or <code>SETIFGREATER</code> or <code>SETIFMATCH</code> <a href="https://microsoft.github.io/garnet/docs/commands/garnet-specific-commands#setifmatch">API</a>) on the database to atomically update <code>(oldValue, etag)</code> to <code>(newValue, etag+1)</code>, and return the new etag to the client.</li>
<li>Use the retrieved ETag from our previous call as an argument for SETIFGREATER to update the cache, so that the cache is updated only if the new tag is greater than what is currently stored in the cache.</li>
</ul>
<p>If every client follows the above protocol. We can ensure that only the last/latest database write will be reflected in the cache, leading to eventual consistency. The same sequencing of events as before, but with the clients following our new updated protocol, is shown below:</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reducing-network-bandwidth-utilization-for-caching">Reducing Network Bandwidth Utilization for Caching<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#reducing-network-bandwidth-utilization-for-caching" class="hash-link" aria-label="Direct link to Reducing Network Bandwidth Utilization for Caching" title="Direct link to Reducing Network Bandwidth Utilization for Caching" translate="no">​</a></h2>
<p>Every network call incurs a cost: the amount of data transmitted and the distance over which it travels. In performance-sensitive scenarios, it's beneficial to fetch data only if it has changed in the cache, thereby reducing bandwidth usage and network latency.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-cache-invalidation">Scenario: Cache Invalidation<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#scenario-cache-invalidation" class="hash-link" aria-label="Direct link to Scenario: Cache Invalidation" title="Direct link to Scenario: Cache Invalidation" translate="no">​</a></h3>
<p>Consider the following setup:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-diagram">High-Level Diagram<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#high-level-diagram" class="hash-link" aria-label="Direct link to High-Level Diagram" title="Direct link to High-Level Diagram" translate="no">​</a></h4>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sequence-diagram">Sequence Diagram<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#sequence-diagram" class="hash-link" aria-label="Direct link to Sequence Diagram" title="Direct link to Sequence Diagram" translate="no">​</a></h4>
<!-- -->
<p>In the absence of ETags, the entire payload for <code>k1</code> is returned on every read, regardless of whether the value associated with <code>k1</code> has changed.</p>
<p>While this might not matter when transferring small payloads (e.g., 100 bytes of data within a high-bandwidth local network), it becomes significant when you have <strong>multiple machines egressing larger payloads (e.g., 1MB each)</strong> on a cloud provider. You pay the cost of egress, bandwidth usage, and experience delays due to the transmission of larger amounts of data.</p>
<p>To address this, Garnet provides the <code>GETIFNOTMATCH</code> API <a href="https://microsoft.github.io/garnet/docs/commands/garnet-specific-commands#getifnotmatch">here</a>.
, allowing you to fetch data only if it has changed since your last retrieval. Server 1 can store the ETag received in the initial payload in application memory and use <code>GETIFNOTMATCH</code> to refresh the local copy only if the value has changed.</p>
<p>This approach is particularly beneficial in read-heavy systems where data changes infrequently. However, for frequently updated keys, using the regular <code>GET</code> API may still be preferable, as updated data will always need to be transmitted.</p>
<p>Take a look at the ETag caching sample to see the usage of the <code>GETIFNOTMATCH</code> API in action.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="avoiding-costly-transactions-when-working-with-non-atomic-operations">Avoiding Costly Transactions When Working with Non-Atomic Operations<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#avoiding-costly-transactions-when-working-with-non-atomic-operations" class="hash-link" aria-label="Direct link to Avoiding Costly Transactions When Working with Non-Atomic Operations" title="Direct link to Avoiding Costly Transactions When Working with Non-Atomic Operations" translate="no">​</a></h2>
<p>Cache-stores such as Garnet rely on key-level (or bucket-level) locks on the server to ensure atomic updates by multiple clients to a key-value pair. We often wish to read a remote value, perform some local computations that update the value, and then write the new value back to the server. Due to the cost of the network round-trip and the potential for clients to crash at any time, holding a server-side lock for such a long duration of time is not possible. ETags offer an alternative to transactions when working with such use cases.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-concurrent-updates-to-the-same-value">Scenario: Concurrent updates to the same Value<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#scenario-concurrent-updates-to-the-same-value" class="hash-link" aria-label="Direct link to Scenario: Concurrent updates to the same Value" title="Direct link to Scenario: Concurrent updates to the same Value" translate="no">​</a></h3>
<p>Imagine multiple clients concurrently modifying an XML document stored in Garnet.</p>
<p>For example:</p>
<ul>
<li>Client 1 reads the XML, updates Field A, and writes it back.</li>
<li>Client 2 reads the same XML, updates Field B, and writes it back concurrently.</li>
</ul>
<p>Without ETags, the following sequence of events might occur:</p>
<ol>
<li>Client 1 reads value <code>v0</code> for key <code>k1</code>.</li>
<li>Client 1 modifies Field A, creating a local copy <code>v1</code>.</li>
<li>Client 2 reads the same value <code>v0</code> before Client 1 writes <code>v1</code>.</li>
<li>Client 2 modifies Field B, creating another local copy <code>v2</code>.</li>
<li>Either Client 1 or Client 2 writes its version back to the server, potentially overwriting the other’s changes since <code>v1</code> and <code>v2</code> both don't have either's changes.</li>
</ol>
<p>This race condition results in lost updates. With ETags, you can use the <code>SETIFMATCH</code> API <a href="https://microsoft.github.io/garnet/docs/commands/garnet-specific-commands#setifmatch">here</a> to implement a <strong>compare-and-swap</strong> mechanism which guarantees that no updates are lost.</p>
<ol>
<li>Client 1 reads value <code>v0</code> for key <code>k1</code>.</li>
<li>Client 1 modifies Field A, creating a local copy <code>v1</code>.</li>
<li>Client 2 reads the same value <code>v0</code> before Client 1 writes <code>v1</code>.</li>
<li>Client 2 modifies Field B, creating another local copy <code>v2</code>.</li>
<li>Client 1 does a <code>SETIFMATCH</code> to try and install its update, which succeeds.</li>
<li>Client 2 does a <code>SETIFMATCH</code> to try and install its update, which fails as the server's ETag has now changed.</li>
<li>Client 2 retries with the updated value, and eventually succeeds in applying its changes to the value.</li>
</ol>
<hr>
<p>The following code snippets demonstrate how this can be achieved.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-code">Example Code<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#example-code" class="hash-link" aria-label="Direct link to Example Code" title="Direct link to Example Code" translate="no">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> userKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Random</span><span class="token plain"> random </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> redis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> ConnectionMultiplexer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ConnectAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GarnetConnectionStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetDatabase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Initially read the latest ETag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> EtagAbstractions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">GetWithEtag</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">ContosoUserInfo</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">long</span><span class="token plain"> etag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Item1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ContosoUserInfo</span><span class="token plain"> userInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Item2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        token</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ThrowIfCancellationRequested</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> userInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> ETagAbstractions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">PerformLockFreeSafeUpdate</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">ContosoUserInfo</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> userKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> userInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ContosoUserInfo</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TooManyCats </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NumberOfCats </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="supporting-methods">Supporting Methods<a href="https://microsoft.github.io/garnet/blog/etags-when-and-how#supporting-methods" class="hash-link" aria-label="Direct link to Supporting Methods" title="Direct link to Supporting Methods" translate="no">​</a></h4>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token return-type class-name punctuation" style="color:#393A34">&lt;</span><span class="token return-type class-name punctuation" style="color:#393A34">(</span><span class="token return-type class-name keyword" style="color:#00009f">long</span><span class="token return-type class-name punctuation" style="color:#393A34">,</span><span class="token return-type class-name"> T</span><span class="token return-type class-name punctuation" style="color:#393A34">?</span><span class="token return-type class-name punctuation" style="color:#393A34">)</span><span class="token return-type class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:#d73a49">GetWithEtag</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">T</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IDatabase</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> executeResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ExecuteAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GETWITHETAG"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">executeResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IsNull</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token type-expression class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">RedisResult</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RedisResult</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">executeResult</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">long</span><span class="token plain"> etag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">T</span><span class="token plain"> item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">Deserialize</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">T</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token return-type class-name punctuation" style="color:#393A34">&lt;</span><span class="token return-type class-name punctuation" style="color:#393A34">(</span><span class="token return-type class-name keyword" style="color:#00009f">long</span><span class="token return-type class-name punctuation" style="color:#393A34">,</span><span class="token return-type class-name"> T</span><span class="token return-type class-name punctuation" style="color:#393A34">)</span><span class="token return-type class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:#d73a49">PerformLockFreeSafeUpdate</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">T</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IDatabase</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">long</span><span class="token plain"> initialEtag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> initialItem</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Action</span><span class="token class-name punctuation" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"> updateAction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Compare and Swap Updating</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">long</span><span class="token plain"> etag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> initialEtag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">T</span><span class="token plain"> item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> initialItem</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// perform custom action, since item is updated to it's correct latest state by the server this action is performed exactly once on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// an item before it is finally updated on the server.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// NOTE: Based on your application's needs you can modify this method to update a pure function that returns a copy of the data and does not use mutations as side effects.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">updateAction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updatedSuccesful</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newEtag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newItem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_updateItemIfMatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        etag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newEtag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">updatedSuccesful</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newItem</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token return-type class-name">Task</span><span class="token return-type class-name punctuation" style="color:#393A34">&lt;</span><span class="token return-type class-name punctuation" style="color:#393A34">(</span><span class="token return-type class-name keyword" style="color:#00009f">bool</span><span class="token return-type class-name"> updated</span><span class="token return-type class-name punctuation" style="color:#393A34">,</span><span class="token return-type class-name"> </span><span class="token return-type class-name keyword" style="color:#00009f">long</span><span class="token return-type class-name"> etag</span><span class="token return-type class-name punctuation" style="color:#393A34">,</span><span class="token return-type class-name"> T</span><span class="token return-type class-name punctuation" style="color:#393A34">?</span><span class="token return-type class-name punctuation" style="color:#393A34">)</span><span class="token return-type class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:#d73a49">_updateItemIfMatch</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">T</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IDatabase</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">long</span><span class="token plain"> etag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> serializedItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">Serialize</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">T</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">RedisResult</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RedisResult</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ExecuteAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SETIFMATCH"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serializedItem</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// successful update does not return updated value so we can just return what was passed for value. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IsNull</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">T</span><span class="token plain"> deserializedItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">Deserialize</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">T</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deserializedItem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Every read-(extra logic/modify)-write call starts by first reading the latest etag and value for a key using <code>GETWITHETAG</code> <a href="https://microsoft.github.io/garnet/docs/commands/garnet-specific-commands#getwithetag">here</a>, it then wraps it's update logic in a callback action and then calls the <code>PerformLockFreeSafeUpdate</code> method in <code>ETagAbstractions</code> to safely apply the update.</p>
<p>Internally the <code>PerformLockFreeSafeUpdate</code> method runs a loop that retrieves the data that performs your update on the object and sends a <code>SETIFMATCH</code> request, the server only then updates the value if your ETag indicates that at the time of your decision you had performed your update on the latest copy of the data. If the server sees that between your read and write there were any updates the value, the server sends the latest copy of the data along with the updated etag, your client code then reapplies the changes on the latest copy and resends the request back to the server for the update, this form of update will guarantees that eventually all changes synchronize themselves on the server one after other.</p>
<p>In a read-heavy system where contention is not high on the same key this update will be performed in the very first loop itself, and be easier to manage than having a custom transaction. However, in a heavy key contention scenario this could result in multiple attempts to write to the latest copy especially if the logic between your read and write is slow.</p>
<hr>
<p>ETags are more of a lower level primitives that you can use to build abstractions that let you build logical clocks, and lock free transactions tailored to your needs. If you find yourself in the above commonly found distributed scenarios, you now have another tool in your toolbag to help overcome your scaling needs.</p>]]></content>
        <author>
            <name>Hamdaan Khalid</name>
            <uri>https://hamdaan-rails-personal.herokuapp.com/about</uri>
        </author>
        <author>
            <name>Badrish Chandramouli</name>
            <uri>https://badrish.net</uri>
        </author>
        <category label="garnet" term="garnet"/>
        <category label="concurrency" term="concurrency"/>
        <category label="caching" term="caching"/>
        <category label="lock-free" term="lock-free"/>
        <category label="etags" term="etags"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[OSS Announcement]]></title>
        <id>https://microsoft.github.io/garnet/blog/msr-blog-announcement</id>
        <link href="https://microsoft.github.io/garnet/blog/msr-blog-announcement"/>
        <updated>2024-03-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[The Microsoft Research Blog has just published a new post introducing Garnet. Check it out here. Have fun!]]></summary>
        <content type="html"><![CDATA[<p>The Microsoft Research Blog has just published a new post introducing Garnet. Check it out <a href="https://www.microsoft.com/en-us/research/blog/introducing-garnet-an-open-source-next-generation-faster-cache-store-for-accelerating-applications-and-services/" target="_blank" rel="noopener noreferrer">here</a>. Have fun!</p>]]></content>
        <author>
            <name>Badrish Chandramouli</name>
            <uri>https://badrish.net</uri>
        </author>
        <category label="garnet" term="garnet"/>
        <category label="oss" term="oss"/>
        <category label="announcement" term="announcement"/>
        <category label="msr" term="msr"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[A Brief History of Garnet]]></title>
        <id>https://microsoft.github.io/garnet/blog/brief-history</id>
        <link href="https://microsoft.github.io/garnet/blog/brief-history"/>
        <updated>2024-03-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hi everyone! I just wanted to start off this blog with a short history of Garnet and how it]]></summary>
        <content type="html"><![CDATA[<p>Hi everyone! I just wanted to start off this blog with a short history of Garnet and how it
came to exist. At Microsoft Research, we have been working on storage technology
for a while. In 2016, we started working on a new key-value store design based on epoch protection and
a powerful storage API. This project, called <a href="https://github.com/microsoft/FASTER" target="_blank" rel="noopener noreferrer">FASTER</a>, was
open-sourced in 2018 and gained a lot of traction within Microsoft and in the larger community. FASTER
has over 6k stars and over half a million NuGet downloads. Over the next several years, we built
follow-on capabilities such as recoverability (CPR) and serverless support (Netherite), and the
project was widely adopted.</p>
<p>Around 2021, we noticed a huge interest in remote cache-stores, particularly using APIs
such as the RESP API of Redis. Developers loved the flexibility of both the API and the
deployment model as a separate process/service. The cost savings compared to accessing
cloud databases directly drove the adoption of caching layers, and these soon
grew to take up a significant portion of the operating cost of large services. When the
pandemic hit and online service usage spiked, there was a strong need for lowering costs
and improving performance (throughput and latency) for such caching layers.</p>
<p>We took on the challenge of building a new system, called Garnet, which could provide
extremely high performance end-to-end in a client-server setup while allowing clients
to remain largely unmodified by adopting RESP, the most popular wire protocols out there.
After a lot of design effort, we came up with a server threading model that could indeed
make a huge end-to-end difference, often by orders-of-magnitude, in performance for
basic get and set operations, with unmodified client code. This gave us the confidence to
build out Garnet's feature set towards use in real scenarios.</p>
<p>The next question was API coverage. The Redis API is vast, and we were just a small research
team. Thankfully, our stack was built on .NET, which made tremendous advances in both performance
and richness of libraries. We designed a generic yet powerful way to define and use custom
data structures, and were able to quickly implement complex datatypes such as Sorted Set, List,
and Hash by reusing data structures in C#. We then built complex structures such as HyperLogLog
and Bitmap as well, and added transactions and extensibility features.</p>
<p>The next requirement was scale-out and recovery, for which we designed write-ahead operation logging,
sharding capability, replication, and key migration for dynamic scale-out. By keeping basic compatibility
with the Redis API, we were able to add these features in a way that existing client code could
be largely unchanged.</p>
<p>After thousands of unit tests and a couple of years working with first-party teams at Microsoft
deploying Garnet in production (more on this in future blog posts!), we felt it was time to release
it publicly, just like we did with FASTER five years back. We wanted developers across the planet to
benefit from this powerful technology and contribute back to the codebase as well. We felt that
the modern C# codebase would be particularly attractive here, in terms of ease of expansion,
maintenance, and contribution. Coming from MSR, we also wanted people in academia to conduct research,
collaborate with us, and expand various aspects of the system.</p>
<p>So, explore Garnet, see if you can find use for it in your applications, consider helping us out
with expanding its capabilities, and as always, let us know what you think!</p>]]></content>
        <author>
            <name>Badrish Chandramouli</name>
            <uri>https://badrish.net</uri>
        </author>
        <category label="garnet" term="garnet"/>
        <category label="history" term="history"/>
        <category label="introduction" term="introduction"/>
    </entry>
</feed>