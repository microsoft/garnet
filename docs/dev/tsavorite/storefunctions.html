<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/tsavorite/storefunctions" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">StoreFunctions and Allocator Wrapper | Garnet</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/garnet/docs/dev/tsavorite/storefunctions"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="StoreFunctions and Allocator Wrapper | Garnet"><meta data-rh="true" name="description" content="This section discusses both of these because they were part of a change to add two additional type args, TStoreFunctions and TAllocator, to TsavoriteKV as well as the various sessions and *Context (e.g. BasicContext). The purpose of both of these is to provide better performance by inlining calls. StoreFunctions also provides better logical design for the location of the operations that are store-level rather than session-level, as described below."><meta data-rh="true" property="og:description" content="This section discusses both of these because they were part of a change to add two additional type args, TStoreFunctions and TAllocator, to TsavoriteKV as well as the various sessions and *Context (e.g. BasicContext). The purpose of both of these is to provide better performance by inlining calls. StoreFunctions also provides better logical design for the location of the operations that are store-level rather than session-level, as described below."><link data-rh="true" rel="icon" href="/garnet/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/garnet/docs/dev/tsavorite/storefunctions"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/tsavorite/storefunctions" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/tsavorite/storefunctions" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"StoreFunctions","item":"https://microsoft.github.io/garnet/docs/dev/tsavorite/storefunctions"}]}</script><link rel="alternate" type="application/rss+xml" href="/garnet/blog/rss.xml" title="Garnet RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/garnet/blog/atom.xml" title="Garnet Atom Feed">




<script>!function(t,e,n,c,a,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/loh6v65ww5",(s=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/garnet/assets/css/styles.b16fc56b.css">
<script src="/garnet/assets/js/runtime~main.5e97eeaf.js" defer="defer"></script>
<script src="/garnet/assets/js/main.a9bb9d6c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/garnet/"><div class="navbar__logo"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Garnet</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/garnet/docs">Docs</a><a class="navbar__item navbar__link" href="/garnet/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/garnet/docs">Welcome</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/news">News</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/features">Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/releases">Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/compatibility">Compatibility</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/about-us">About Us</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/getting-started">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/benchmarking/overview">Benchmarking</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/commands/overview">Commands</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/extensions/overview">Server Extensions</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/cluster/overview">Cluster Mode</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/garnet/docs/dev/onboarding">Developer Guide</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/onboarding">Onboarding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/code-structure">Code Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/network">Network Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/processing">Processing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/garnet-api">Garnet API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/garnet/docs/dev/tsavorite/intro">Tsavorite - Storage Layer</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/tsavorite/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/tsavorite/reviv">Revivification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/tsavorite/locking">Locking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/garnet/docs/dev/tsavorite/storefunctions">StoreFunctions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/tsavorite/epoch">EpochProtection</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/transactions">Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/custom-commands">Custom Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/multi-db">Logical Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/collection-broker">Collection Broker</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/garnet/docs/dev/cluster/overview">Cluster</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/contributing">Contributing</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/research/papers">Research</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="https://github.com/microsoft/garnet/releases" target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false">Other Links</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/garnet/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer Guide</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tsavorite - Storage Layer</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">StoreFunctions</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>StoreFunctions and Allocator Struct Wrapper</h1></header>
<p>This section discusses both of these because they were part of a change to add two additional type args, <code>TStoreFunctions</code> and <code>TAllocator</code>, to <code>TsavoriteKV</code> as well as the various sessions and <code>*Context</code> (e.g. <code>BasicContext</code>). The purpose of both of these is to provide better performance by inlining calls. StoreFunctions also provides better logical design for the location of the operations that are store-level rather than session-level, as described below.</p>
<p>From the caller point of view, we have two new type parameters on <code>TsavoriteKV&lt;TKey, TValue, TStoreFunctions, TAllocator&gt;</code>. The <code>TStoreFunctions</code> and <code>TAllocator</code> are also on <code>*.Context</code> (e.g. <code>BasicContext</code>) as well. C# allows the &#x27;using&#x27; alias only as the first lines of a namespace declaration, and the alias is file-local and recognized by subsequent &#x27;using&#x27; aliases, so the &quot;Api&quot; aliases such as <code>BasicGarnetApi</code> in multiple files are much longer now.</p>
<p><code>TsavoriteKV</code> constructor has been changed to take 3 parameters:</p>
<ul>
<li><code>KVSettings&lt;TKey, TValue&gt;</code>. This replaces the previous long list of parameters. <code>LogSettings</code>, <code>ReadCacheSettings</code>, and <code>CheckpointSettings</code> have become internal classes, used only by <code>TsavoriteKV</code> (created from <code>TsavoriteKVSettings</code>) when instantiating the Allocators (e.g. the new <code>AllocatorSettings</code> has a <code>LogSettings</code> member). <code>SerializerSettings</code> has been removed in favor of methods on <code>IStoreFunctions</code>.</li>
<li>An instance of <code>TStoreFunctions</code>. This is usually obtained by a call to a static <code>StoreFunctions</code> factory method to create it, passing the individual components to be contained.</li>
<li>A factory <code>Func&lt;&gt;</code> for the <code>TAllocator</code> instantiation.</li>
</ul>
<p>These are described in more detail below.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="storefunctions-overview">StoreFunctions overview<a href="#storefunctions-overview" class="hash-link" aria-label="Direct link to StoreFunctions overview" title="Direct link to StoreFunctions overview">​</a></h2>
<p><code>StoreFunctions</code> refers to the set of callback functions that reside at the <code>TsavoriteKV</code> level, analogous to <code>ISessionFunctions</code> at the session level. Similar to <code>ISessionFunctions</code>, there is an <code>IStoreFunctions</code>. However, the <code>ISessionFunctions</code> implementation can be either a struct or a class&#x27; Tsavorite provides the <code>SessionFunctionsBase</code> class, which may be inherited from, as a utility. Type parameters implemented by classes, however, do not generate inlined code.</p>
<p>Because <code>IStoreFunctions</code> is intended to provide maximum inlining, Tsavorite does not provide a <code>StoreFunctionsBase</code>. Instead, Tsavorite provides a <code>StoreFunctions</code> struct implementation, with optional implementations passed in, for:</p>
<ul>
<li>Key Comparison (previously passed as an <code>ITsavoriteKeyComparer</code> interface, which is not inlined)</li>
<li>Key and Value Serializers. Due to limitations on type arguments, these must be passed as <code>Func&lt;&gt;</code> which creates the implementation instance, and because serialization is an expensive operation, we stay with the <code>IObjectSerializer&lt;TKey&gt;</code> and <code>IObjectSerializer&lt;TValue&gt;</code> interfaces rather than clutter the <code>IStoreFunctions&lt;TKey, TValue&gt;</code> interface with the Key and Value Serializer type args.</li>
<li>Record disposal (previously on <code>ISessionFunctions</code> as multiple methods, and now only a single method with a &quot;reason&quot; parameter).</li>
<li>Checkpoint completion callback (previously on <code>ISessionFunctions</code>).</li>
</ul>
<p>Of course, because <code>TsavoriteKV</code> has the <code>TStoreFunctions</code> type parameter, this can be any type implemented by the caller, including a class instance (which would be slower).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="allocator-wrapper-overview">Allocator Wrapper overview<a href="#allocator-wrapper-overview" class="hash-link" aria-label="Direct link to Allocator Wrapper overview" title="Direct link to Allocator Wrapper overview">​</a></h2>
<p>As with <code>StoreFunctions</code>, the Allocator Wrapper is intended to provide maximal inlining. As noted above, type parameters implemented by classes do not generate inlined code; the JITted code is general, for a single <code>IntPtr</code>-sized reference. For structs, however, the JITter generates code specific to that specific struct type, in part because the size can vary (e.g. when pushed on the stack as a parameter).</p>
<p>There is a hack that allows a type parameter implemented by a class to be inlined: the generic type must be for a struct that wraps the class type and makes calls on that class type in a non-generic way. This is the approach the Allocator Wrapper takes:</p>
<ul>
<li>The <code>BlittableAllocator</code>, <code>GenericAllocator</code>, and <code>SpanByteAllocator</code> classes are now the wrapper structs, with <code>Key</code>, <code>Value</code>, and <code>TStoreFunctions</code> type args. These implement the <code>IAllocator</code> interface.</li>
<li>There are new <code>BlittableAllocatorImpl</code>, <code>GenericAllocatorImpl</code>, and <code>SpanByteAllocatorImpl</code> classes that implement most of the functionality as previously, including inheriting from <code>AllocatorBase</code>. These also have <code>Key</code>, <code>Value</code>, and <code>TStoreFunctions</code> type args; the <code>TAllocator</code> is not needed as a type arg because it is known to be the <code>XxxAllocator</code> Wrapper struct. The wrapper structs contain an instance of the <code>XxxAllocatorImpl</code> class.</li>
<li><code>AllocatorBase</code> itself now contains a <code>_wrapper</code> field that is a struct-wrapper instance (which contains the instance pointer of the fully-derived allocator class) that is constrained to the <code>IAllocator</code> interface. <code>AllocatorBase</code> itself is templated on <code>TStoreFunctions</code> and <code>TAllocator</code>.</li>
</ul>
<p>The new Allocator definition supports two interfaces:</p>
<ul>
<li><code>IAllocatorCallbacks</code>, which is inherited by <code>IAllocator</code>. This contains the derived-Allocator methods called by <code>AllocatorBase</code> that we want to inline rather then virtcall. The struct wrapper <code>AllocatorBase._wrapper</code> implements <code>IAllocatorCallbacks</code>, so the call on <code>_wrapper</code> inlines the call to <code>IAllocatorCallbacks</code>, which then calls down to the derived <code>*AllocatorImpl</code> class implementation.</li>
<li><code>IAllocator : IAllocatorCallbacks</code>. This is all inlined calls on the Allocator, including <code>IAllocatorCallbacks</code>.<!-- -->
<ul>
<li>It turns out not to be possible to keep <code>IAllocatorCalbacks</code> as a separate type arg because <code>IAllocator</code> must propagate, but <code>IAllocatorCallbacks</code> remains as a separate interface (instead of combining it all into <code>IAllocator</code>) as the organization may be useful.</li>
</ul>
</li>
</ul>
<p>There are still a number of abstract <code>AllocatorBase</code> methods, for which inlining of the method call is not important due to the time for the overall call. These are mostly IO and Scan/Iteration methods.</p>
<p>Within <code>TsavoriteKV</code>, we have:</p>
<ul>
<li><code>hlog</code> remains, but is now of type <code>TAllocator</code> (the wrapper struct).</li>
<li><code>hlogBase</code> is new; it is the <code>AllocatorBase</code>. All the calls on the allocator that we don’t need to inline (or are not virtual, such as *Address) are now called on hlogBase.<!-- -->
<ul>
<li>It might be cleaner to rename these to <code>allocator</code> and <code>allocatorBase</code>.</li>
</ul>
</li>
</ul>
<p>There is a new <code>AllocatorSettings</code> class as well that is created by <code>TsavoriteKV</code> when instantiating the allocator. Allocator instantiation is done by a factory <code>Func&lt;AllocatorSettings, TStoreFunctions&gt;</code> rather that being passed in as an object, because:</p>
<ul>
<li>The caller would have to know more internal stuff such as the epoch, whether to create readcache, and so on.</li>
<li>We create temporary <code>TsavoriteKV</code>s, such as when Scanning or Compacting, so there is no way to pass these instances in.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/microsoft/garnet/tree/main/website/docs/dev/tsavorite/storefunctions.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/garnet/docs/dev/tsavorite/locking"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Locking</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/garnet/docs/dev/tsavorite/epoch"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">EpochProtection</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#storefunctions-overview" class="table-of-contents__link toc-highlight">StoreFunctions overview</a></li><li><a href="#allocator-wrapper-overview" class="table-of-contents__link toc-highlight">Allocator Wrapper overview</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/docs/getting-started">Getting Started</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://aka.ms/garnet-discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/msrgarnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p class="text-center">
          <a href="https://go.microsoft.com/fwlink/?LinkId=521839" style="color: white;">Privacy &amp; Cookies</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=2259814" style="color: white;">Consumer Health Privacy</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=206977" style="color: white;">Terms of Use</a> |
          <a href="https://www.microsoft.com/trademarks" style="color: white;">Trademarks</a> | © 2025
          </p></div></div></div></footer></div>
</body>
</html>