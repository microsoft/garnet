<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/transactions" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Transactions | Garnet</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/garnet/docs/dev/transactions"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Transactions | Garnet"><meta data-rh="true" name="description" content="Garnet supports two types of transactions:"><meta data-rh="true" property="og:description" content="Garnet supports two types of transactions:"><link data-rh="true" rel="icon" href="/garnet/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/garnet/docs/dev/transactions"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/transactions" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/transactions" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Transactions","item":"https://microsoft.github.io/garnet/docs/dev/transactions"}]}</script><link rel="alternate" type="application/rss+xml" href="/garnet/blog/rss.xml" title="Garnet RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/garnet/blog/atom.xml" title="Garnet Atom Feed">




<script>!function(t,e,n,c,a,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/loh6v65ww5",(s=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/garnet/assets/css/styles.c254282c.css">
<script src="/garnet/assets/js/runtime~main.95f3c7b4.js" defer="defer"></script>
<script src="/garnet/assets/js/main.06a356fa.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/garnet/"><div class="navbar__logo"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Garnet</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/garnet/docs">Docs</a><a class="navbar__item navbar__link" href="/garnet/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/garnet/docs">Welcome</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/news">News</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/features">Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/releases">Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/compatibility">Compatibility</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/about-us">About Us</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/getting-started">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/benchmarking/overview">Benchmarking</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/commands/overview">Commands</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/extensions/overview">Server Extensions</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/cluster/overview">Cluster Mode</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/garnet/docs/dev/onboarding">Developer Guide</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/onboarding">Onboarding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/code-structure">Code Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/network">Network Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/processing">Processing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/garnet-api">Garnet API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/garnet/docs/dev/tsavorite/intro">Tsavorite - Storage Layer</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/garnet/docs/dev/transactions">Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/custom-commands">Custom Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/multi-db">Logical Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/collection-broker">Collection Broker</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/garnet/docs/dev/cluster/overview">Cluster</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/contributing">Contributing</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/research/papers">Research</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="https://github.com/microsoft/garnet/releases" target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false">Other Links</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/garnet/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer Guide</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Transactions</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Transactions</h1></header>
<p>Garnet supports two types of transactions:</p>
<ol>
<li>Custom Server-side Transactions</li>
<li>Client-Issued Transactions (Redis)</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="custom-server-side-transactions">Custom Server-side Transactions<a href="#custom-server-side-transactions" class="hash-link" aria-label="Direct link to Custom Server-side Transactions" title="Direct link to Custom Server-side Transactions">​</a></h2>
<p>Custom transactions allows adding a new transaction and registering it with Garnet on the server side. This registered transaction can then be invoked from any Garnet client to perform a transaction on the Garnet server.
Read more on developing custom server side transactions in the <a href="/garnet/docs/extensions/transactions">Transactions page</a> under the Extensions section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="client-issued-transactions-redis">Client-Issued Transactions (Redis)<a href="#client-issued-transactions-redis" class="hash-link" aria-label="Direct link to Client-Issued Transactions (Redis)" title="Direct link to Client-Issued Transactions (Redis)">​</a></h2>
<p>You can read more here: <a href="https://redis.io/docs/manual/transactions" target="_blank" rel="noopener noreferrer">Redis Transactions</a>. In this design, transaction operations come in a MULTI/EXEC scope. Every operation in this scope is part of the transaction.
The model does not allow you to use the result of reads inside the MULTI/EXEC scope but allows you to read and monitor keys before (i.e., watch), and if they are unchanged at the time of execution, the transaction will commit.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WATCH mykey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val = GET mykey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val = val + 1 # not Redis command this happens outside</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MULTI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET mykey $val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXEC</span><br></span></code></pre></div></div>
<p>In the above example, if <strong>mykey</strong> changes before <strong>EXEC</strong> command, the transaction will abort since the calculation of <em>val</em> is invalidated.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-backend">Transaction Backend<a href="#transaction-backend" class="hash-link" aria-label="Direct link to Transaction Backend" title="Direct link to Transaction Backend">​</a></h3>
<p>Transactions in Garnet are implemented using the following classes:</p>
<ul>
<li><code>TransactionManager</code></li>
<li><code>WatchVersionMap</code></li>
<li><code>WatchedKeyContainer</code></li>
<li><code>RespCommandsInfo</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transactionmanager-class-responsibilities">TransactionManager Class Responsibilities<a href="#transactionmanager-class-responsibilities" class="hash-link" aria-label="Direct link to TransactionManager Class Responsibilities" title="Direct link to TransactionManager Class Responsibilities">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="storing-the-state-of-transaction">Storing the state of Transaction:<a href="#storing-the-state-of-transaction" class="hash-link" aria-label="Direct link to Storing the state of Transaction:" title="Direct link to Storing the state of Transaction:">​</a></h4>
<ul>
<li><strong>Started</strong>: Goes to this state after <code>MULTI</code> command, TxnManager will queue any command in this state except EXEC</li>
<li><strong>Running</strong>: Goes to this state after EXEC, TxnManager will run the queued commands in this state</li>
<li><strong>Aborted</strong>: Goes to this state in case of anything bad happens</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="queueing-commands">Queueing Commands:<a href="#queueing-commands" class="hash-link" aria-label="Direct link to Queueing Commands:" title="Direct link to Queueing Commands:">​</a></h4>
<p>When TxnManager goes to <em>Started</em> state, it will (1) queue any command afterward and (2) save any key that is used in those commands to lock at the execution time using 2PL.
In order to queue commands, they are <strong>let to live in the network buffer</strong>. Using the <code>TrySkip</code> function in <code>RespServerSession</code>. To lock the keys at the time of execution, we save pointers to the actual memory location of keys in the network buffer using an array of <code>TxnKeyEntry</code> that has an <code>ArgSlice</code> and the lock type (Shared or Exclusive).</p>
<p><code>TrySkip</code> function uses <code>RespCommandsInfo</code> class to skip the correct number of tokens and detects syntax errors. <code>RespCommandsinfo</code> stores the number of <code>Arity</code> or arguments of each command. E.g., the <code>GET</code> command&#x27;s arity is two. The command token <code>GET</code> and one key. We store the minimum number of arguments with a negative value for the commands that can have multiple arguments. <code>SET</code> command&#x27;s arity is  -3 means that it requires at least three arguments (including command toke).</p>
<p>During the <code>TrySkip</code> we call <code>TransactionManager.GetKeys</code>, which goes over the arguments and stores <code>TxnKeyEntry</code> for each key in the arguments.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="execution">Execution<a href="#execution" class="hash-link" aria-label="Direct link to Execution" title="Direct link to Execution">​</a></h4>
<p>When the the <code>TxnState</code> is <em>Started</em> and we encounter the <code>EXEC</code> we call <code>TransactionManager.Run()</code>. What this functions does:</p>
<ol>
<li>first acquires the <code>LockableContext</code> for the main store and/or object store based on the store type.</li>
<li>Goes over <code>TxnKeyEntry</code>s and locks all the needed keys.</li>
<li>Calls <code>WatchedKeyContainer.ValidateWatchVersion()</code>
<ul>
<li>It goes over all the watched keys and checks whether their version is the same as the time watch or not</li>
<li>if it passes, we proceed with execution otherwise, we call <code>TransactionManager.Reset(true)</code> to reset the transaction manager. The <code>true</code> argument we pass to <code>Reset</code> says that it also needs to unlock the keys.</li>
</ul>
</li>
<li>It writes the transaction start indicator in the AOF to recover atomically in case of failure in the middle of the transaction</li>
</ol>
<p>After that, the TxnState is set to <em>Running</em> and the network <code>readHead</code> is set to the first command after <code>MULTI</code>, and this time we start actually running those commands. When the execution reaches to EXEC again, and we are in <em>Running</em> state, it calls <code>TransactionManager.Commit()</code>. What it does:</p>
<ul>
<li>Unlock all the keys that we locked in <code>Run</code></li>
<li>Reset <code>TransactionManager</code> and <code>WatchedKeyContainer</code></li>
<li>It also appends the commit message to the AOF</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="recovery-optimization">Recovery Optimization<a href="#recovery-optimization" class="hash-link" aria-label="Direct link to Recovery Optimization" title="Direct link to Recovery Optimization">​</a></h3>
<p>Garnet does regular checkpoints and changes its version between those checkpoints. In order to get checkpoint consistency, we require transaction operations to have the same version or in other words be in the same checkpoint window.</p>
<p>To enforce this right now, we do the following:</p>
<ul>
<li>When TsavoriteStateMachine is in <code>Prepare</code> phase, we do not let a transaction start execution to let checkpoint finish</li>
<li>If there is a running transaction and TsavoriteStateMachine moves to <code>Prepare</code> we don&#x27;t let version change happen until the transaction finishes the execution.</li>
<li>These two happen using <code>session.IsInPreparePhase</code> and two while loop at the beginning of <code>Run</code> function</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="watch-command">Watch Command<a href="#watch-command" class="hash-link" aria-label="Direct link to Watch Command" title="Direct link to Watch Command">​</a></h3>
<p>It is used to implement optimistic locking.</p>
<ul>
<li>Provide a check-and-set (CAS) behavior to transactions.</li>
<li>Keys are monitored in order to detect changes against them.</li>
<li>If at least one watched key is modified before the EXEC  command, the whole transaction aborts</li>
<li>It is implemented through a <code>Modified</code> bit in <code>TsavoriteKV</code> and a <strong><code>VersionMap</code></strong> in <code>Garnet</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="version-map">Version Map<a href="#version-map" class="hash-link" aria-label="Direct link to Version Map" title="Direct link to Version Map">​</a></h4>
<p>It Monitors modifications on the keys. Every time a watched key gets modified, we increment its version in the version map.</p>
<ul>
<li>It has been implemented through a <code>Hash Index</code></li>
<li>To prevent the overhead for normal operations in the critical path we only increment the version in some cases:<!-- -->
<ul>
<li>
<p>For in-memory records, we only increment version <strong>watched keys</strong>. The keys that are watched in Garnet use the <code>Modified</code> bit in Tsavorite to track modification (more on Modified bit Below)</p>
</li>
<li>
<p>For records in the disk, we increment the version for <strong>copy-update</strong> RMWs and Upserts. <strong>We intentionally accept this overhead because copy updates are less often, and the overhead is not crucial.</strong></p>
</li>
<li>
<p>Increment the version in <code>MainStoreFunctions</code> and <code>ObjectStoreFunctions</code>:</p>
<ul>
<li><code>InPlaceUpdater</code> if it is watched</li>
<li><code>ConcurrentWriter</code> if it is watched</li>
<li><code>ConcurrentDeleter</code> if it is watched</li>
<li><code>PostSingleWriter</code></li>
<li><code>PostInitialUpdater</code></li>
<li><code>PostCopyUpdater</code></li>
<li><code>PostSingleDeleter</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="modified-bit">Modified Bit<a href="#modified-bit" class="hash-link" aria-label="Direct link to Modified Bit" title="Direct link to Modified Bit">​</a></h4>
<p>The Modified bit tracks modifications in records in Tsavorite. The modified bit for each record gets set to &quot;1&quot; when they get modified and <strong>Remains</strong> &quot;1&quot; until somebody Reset it to zero using the <code>ResetModified</code> API.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="watch">Watch<a href="#watch" class="hash-link" aria-label="Direct link to Watch" title="Direct link to Watch">​</a></h4>
<ul>
<li>We add a <code>ClientSesssion.ResetModified(ref Key key)</code> API.<!-- -->
<ul>
<li>CAS the <code>RecordInfo</code> word into the same word, but with the <strong>modified bit reset</strong>.</li>
</ul>
</li>
<li>When somebody watches a key in Garnet, we call <code>ResetModified</code> API and store that key in <code>WatchedKeyContainer</code>.</li>
<li>At the time of watch, we read a version of that record from the version map and store it alongside the key in <code>WatchedKeyContainer</code>.</li>
<li>At the time of Transaction Execution, we go through all keys in <code>WatchedKeyContainer</code> and if their version is still the same, we proceed with the transactions</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="unwatch">Unwatch<a href="#unwatch" class="hash-link" aria-label="Direct link to Unwatch" title="Direct link to Unwatch">​</a></h4>
<ul>
<li>When a record gets modified in Tsavorite the modified bit gets set automatically</li>
<li>When a user calls <code>Unwatch</code> API in Garnet we simply just reset the <code>WatchedKeyContainer</code></li>
<li>After every <code>DISCARD</code>, <code>EXEC</code>, <code>UNWATCH</code> command we unwatch everything</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing<a href="#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h3>
<p>We have written a micro-benchmark <code>TxnPerfBench</code> to test client transactions. The benchmark contains four different workloads:</p>
<ul>
<li>READ_TXN</li>
<li>WRITE_TXN</li>
<li>READ_WRITE_TXN</li>
<li>WATCH_TXN</li>
</ul>
<p>It looks like the online benchmark, and can have different percentages of different workloads:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dotnet run -c Release -t 2 -b 1 --dbsize 1024 -x --client SERedis --op-workload WATCH_TXN --op-percent 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dotnet run -c Release -t 2 -b 1 --dbsize 1024 -x --client SERedis --op-workload READ_TXN,WRITE_TXN --op-percent 50,50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dotnet run -c Release -t 2 -b 1 --dbsize 1024 -x --client SERedis --op-workload READ_WRITE_TXN --op-percent 100</span><br></span></code></pre></div></div>
<p>Before running the benchmark, we load data with <code>opts.DbSize</code> number of records. It also accepts the number of reads and writes per transaction:</p>
<p><code>TxnPerfBench(..., int readPerTxn = 4, int writePerTxn = 4)</code></p>
<ul>
<li>We only support batch size of one.</li>
<li>We only support the SE.Redis client for now.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="read_txn">READ_TXN<a href="#read_txn" class="hash-link" aria-label="Direct link to READ_TXN" title="Direct link to READ_TXN">​</a></h4>
<p>Runs a transaction with <code>readPerTxn</code> number of <code>GET</code> requests;</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="write_txn">WRITE_TXN<a href="#write_txn" class="hash-link" aria-label="Direct link to WRITE_TXN" title="Direct link to WRITE_TXN">​</a></h4>
<p>Runs a transaction with <code>writePerTxn</code> number of <code>SET</code> requests;</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="read_write_txn">READ_WRITE_TXN<a href="#read_write_txn" class="hash-link" aria-label="Direct link to READ_WRITE_TXN" title="Direct link to READ_WRITE_TXN">​</a></h4>
<p>Runs a mix of <code>SET</code> and <code>GET</code> request (<code>readPerTxn</code>, <code>writePerTxn</code>)</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="watch_txn">WATCH_TXN<a href="#watch_txn" class="hash-link" aria-label="Direct link to WATCH_TXN" title="Direct link to WATCH_TXN">​</a></h4>
<p>This workload watches <code>readPerTxn</code> number of keys. Then starts a transaction, reads the watched keys, and writes to <code>writePerTxn</code> number of keys.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">readPerTxn = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writePerTxn = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WATCH x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WATCH x2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MULTI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET x2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET x3 v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET x4 v4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXEC</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/microsoft/garnet/tree/main/website/docs/dev/transactions.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/garnet/docs/dev/tsavorite/epoch"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">EpochProtection</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/garnet/docs/dev/custom-commands"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Custom Commands</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#custom-server-side-transactions" class="table-of-contents__link toc-highlight">Custom Server-side Transactions</a></li><li><a href="#client-issued-transactions-redis" class="table-of-contents__link toc-highlight">Client-Issued Transactions (Redis)</a><ul><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#transaction-backend" class="table-of-contents__link toc-highlight">Transaction Backend</a></li><li><a href="#transactionmanager-class-responsibilities" class="table-of-contents__link toc-highlight">TransactionManager Class Responsibilities</a></li><li><a href="#recovery-optimization" class="table-of-contents__link toc-highlight">Recovery Optimization</a></li><li><a href="#watch-command" class="table-of-contents__link toc-highlight">Watch Command</a></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/docs/getting-started">Getting Started</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://aka.ms/garnet-discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/msrgarnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p class="text-center">
          <a href="https://go.microsoft.com/fwlink/?LinkId=521839" style="color: white;">Privacy &amp; Cookies</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=2259814" style="color: white;">Consumer Health Privacy</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=206977" style="color: white;">Terms of Use</a> |
          <a href="https://www.microsoft.com/trademarks" style="color: white;">Trademarks</a> | © 2025
          </p></div></div></div></footer></div>
</body>
</html>