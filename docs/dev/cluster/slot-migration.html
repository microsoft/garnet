<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/cluster/slot-migration" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Migration Overview | Garnet</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/garnet/docs/dev/cluster/slot-migration"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Migration Overview | Garnet"><meta data-rh="true" name="description" content="In Garnet, slot migration describes the process of reassigning slot ownership and transferring the associated key-value pairs from one primary node to another within a fully operational cluster."><meta data-rh="true" property="og:description" content="In Garnet, slot migration describes the process of reassigning slot ownership and transferring the associated key-value pairs from one primary node to another within a fully operational cluster."><link data-rh="true" rel="icon" href="/garnet/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/garnet/docs/dev/cluster/slot-migration"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/cluster/slot-migration" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/cluster/slot-migration" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Migration","item":"https://microsoft.github.io/garnet/docs/dev/cluster/slot-migration"}]}</script><link rel="alternate" type="application/rss+xml" href="/garnet/blog/rss.xml" title="Garnet RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/garnet/blog/atom.xml" title="Garnet Atom Feed">




<script>!function(t,e,n,c,a,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/loh6v65ww5",(s=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/garnet/assets/css/styles.d25881ce.css">
<script src="/garnet/assets/js/runtime~main.98b913d1.js" defer="defer"></script>
<script src="/garnet/assets/js/main.b10a522d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/garnet/"><div class="navbar__logo"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Garnet</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/garnet/docs">Docs</a><a class="navbar__item navbar__link" href="/garnet/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/garnet/docs">Welcome</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/news">News</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/features">Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/releases">Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/compatibility">Compatibility</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/about-us">About Us</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/getting-started">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/benchmarking/overview">Benchmarking</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/commands/overview">Commands</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/extensions/overview">Server Extensions</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/cluster/overview">Cluster Mode</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/garnet/docs/dev/onboarding">Developer Guide</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/onboarding">Onboarding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/code-structure">Code Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/network">Network Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/processing">Processing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/garnet-api">Garnet API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/garnet/docs/dev/tsavorite/intro">Tsavorite - Storage Layer</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/transactions">Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/custom-commands">Custom Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/multi-db">Logical Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/collection-broker">Collection Broker</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/garnet/docs/dev/cluster/overview">Cluster</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/cluster/overview">Cluster Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/cluster/sharding">Sharding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/garnet/docs/dev/cluster/slot-migration">Migration</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/contributing">Contributing</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/research/papers">Research</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="https://github.com/microsoft/garnet/releases" target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false">Other Links</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/garnet/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer Guide</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Cluster</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Migration</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Slot Migration Overview</h1></header>
<p>In Garnet, slot migration describes the process of reassigning slot ownership and transferring the associated key-value pairs from one primary node to another within a fully operational cluster.
This operation allows for efficient resource utilization and load balancing across the cluster when adding or removing nodes.
The migration operation is only available in cluster mode.
Slot migration can be initiated by the owner (referred to as the <em>source</em> node) of a given slot, and addressed towards another already known, and trusted primary node (referred to as the <em>target</em> node).
Actual data migration can be initiated by using the <code>MIGRATE </code> command that operates in two modes: (1) Migrate individual keys (2) Migrate entire slots or range of slots.
This page is focused on the slot migration implementation details.
For more information about using the associated command refer to the slot migration <a href="/garnet/docs/cluster/key-migration">user guide</a>.</p>
<h1>Implementation Details</h1>
<p>The implementation of the migration operation is separated into two components:</p>
<ol>
<li>Command parsing and validation component.</li>
<li>Migration session operation and management component.</li>
</ol>
<p>The first component is responsible for parsing and validating the migration command arguments.
Validation involves the following:</p>
<ol>
<li>Parse every migration option and validate arguments associated with that option.</li>
<li>Validate ownership of associated slot that is about to be migrated.</li>
<li>For <code>KEYS</code> option, validate that keys to be migrated do not hash across different slots.</li>
<li>For <code>SLOTS/SLOTSRANGE</code> option, validate no slot is referenced multiple times.</li>
<li>For <code>SLOTSRANGE</code> option, make sure a range is defined by a pair of values.</li>
<li>Validate that the target of the migration is known, trusted and has the role of a primary.</li>
</ol>
<p>When parsing completes succesfully, a <em>migration</em> session is created and executed.
Depending on the chosen option, the <em>migration</em> session executes either as a foreground task (using <code>KEYS</code> option) or a background task (<code>SLOTS/SLOTSRANGE</code> option).</p>
<p>The second component is separated into the following sub-components:</p>
<ol>
<li><code>MigrationManager</code></li>
<li><code>MigrateSessionTaskStore</code></li>
<li><code>MigrateSession</code></li>
</ol>
<p>The <code>MigrationManager</code> is responsible for managing the active <code>MigrateSession</code> tasks.
It uses the <code>MigrateSessionTaskStore</code> to atomically add or remove new instances of <code>MigrateSession</code>.
It is also responsible for ensuring that existing sessions do not conflict with sessions that are about to be added, by checking if the referred slots in each session do not conflict.
Finally, it provideds information on the number of ongoing migrate tasks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migration-data-integrity">Migration Data Integrity<a href="#migration-data-integrity" class="hash-link" aria-label="Direct link to Migration Data Integrity" title="Direct link to Migration Data Integrity">​</a></h2>
<p>Since slot migration can be initiated while a Garnet cluster is operational, it needs to be carefully orchestrated to avoid any data integrity issues when clients attempt to write new data.
In addition, whatever solution is put forth should not hinder data avaibility while migration is in progress.</p>
<p>Our implementation leverages on the concept of slot-based sharding to ensure that keys mapping to the related slot cannot be modified while a migrate task is active.
This is achieved by setting the slot state to <em><strong>MIGRATING</strong></em> in the source node.
This prevents any write requests though it still allows for reads.
Write requests can be issued towards the target node using <em><strong>ASKING</strong></em>, though there are not consistency guarantees from Garnet if this option is used.
Garnet guarantees that no keys can be lost during regular migration (i.e. with using <em><strong>ASKING</strong></em>).</p>
<p>Because Garnet operates in a multi-threaded environment, the transition from <code>STABLE</code> to <code>MIGRATING</code> needs to happen safely, so every thread has a chance to observe that state change.
This can happen using epoch protection.
Specifically, when a slot transitions to a new state, the segment that implements the actual state transition will have to spin-wait after making the change and return only after all active client sessions have moved to the next epoch.</p>
<p>An excerpt of the code related to epoch protection during slot state transition is shown below.
Every client session, before processing an incoming packet, will first acquire the current epoch.
This also happens for the client session that issues a slot state transition command (i.e. CLUSTER SETSLOT).
On success of updating the local config command, the processing thread of the previous command will perform the following:</p>
<ol>
<li>release the current epoch (in order to avoid waiting for itselft to transition).</li>
<li>spin-wait until all thread transition to next epoch.</li>
<li>re-acquire the next epoch.</li>
</ol>
<p>This series of steps ensures that on return, the processing thread guarantees to the command issuer (or the method caller if state transition happens internally), that the state transition is visible to all threads that were active.
Therefore, any active client session will process subsequent commands considering the new slot state.</p>
<div class="docusaurus-theme-github-codeblock"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Wait for Config</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">loading</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:right;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/microsoft/garnet/blob/951cf82c120d4069e940e832db03bfa018c688ea/libs/cluster/Server/ClusterProvider.cs#L271-L296" class="githubLink" style="margin:0 10px" target="_blank">View on GitHub</a></div></div>
<p>During migration, the change in slot state (i.e., <code>MIGRATING</code>) is transient from the perspective of the source node.
This means that until migration completes the slot is still owned by the source node.
However, because it is necessary to produce <code>-ASK</code> redirect messages, the <em>workerId</em> is set to the <em>workerId</em> of the target node, without bumping the current local epoch (to avoid propagation of this transient update to the whole cluster).
Therefore, depending on the context of the operation being executed, the actual owner of the node can be determined by accessing <em>workerId</em> property, while the target node for migration is determined through <em>_workerId</em> variable.
For example, the <code>CLUSTER NODES</code> will use <em>workerId</em> property (through GetSlotRange(<em>workerId</em>)) since it has to return actual owner of the node even during migration.
At the same, time it needs to return all nodes that are in <code>MIGRATING</code> or <code>IMPORTING</code> state and the node-id associated with that state which can be done by inspecting the <em>_workerId</em> variable (through GetSpecialStates(<em>workerId</em>)).</p>
<div class="docusaurus-theme-github-codeblock"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CLUSTER NODES Implementation</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">loading</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:right;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/microsoft/garnet/blob/951cf82c120d4069e940e832db03bfa018c688ea/libs/cluster/Server/ClusterConfig.cs#L499-L521" class="githubLink" style="margin:0 10px" target="_blank">View on GitHub</a></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrate-keys-implementation-details">Migrate KEYS Implementation Details<a href="#migrate-keys-implementation-details" class="hash-link" aria-label="Direct link to Migrate KEYS Implementation Details" title="Direct link to Migrate KEYS Implementation Details">​</a></h2>
<p>Using the <code>KEYS</code> option, Garnet will iterate through the provided list of keys and migrate them in batches to the target node.
When using this option, the issuer of the migration command will have to make sure that the slot state is set appropriately in the source, and target node.
In addition, the issuer has to provide all keys that map to a specific slot either in one call to <code>MIGRATE</code> or across multiple call before the migration completes.
When all key-value pairs have migrated to the target node, the issuer has to reset the slot state and assign ownership of the slot to the new node.</p>
<p><code>MigrateKeys</code> is the main driver for the migration operation using the <code>KEYS</code> option.
This method iterates over the list of provided keys and sends them over to the target node.
This occurs in the following two phases:</p>
<ol>
<li>find all keys provided by <code>MIGRATE</code> command and send them over to the <em>target</em> node.</li>
<li>for all remaining keys not found in the main store, lookup into the object store, and if they are found send them over to the <em>target</em> node.
It is possible that a given key cannot be retrieved from either store, because it might have expired.
In that case, execution proceeds to the next available key and no specific error is raised.
When data transmission completes, and depending if COPY option is enabled, <code>MigrateKeys</code> deletes the keys from the both stores.</li>
</ol>
<div class="docusaurus-theme-github-codeblock"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MigrateKeys Main Method</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">loading</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:right;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/microsoft/garnet/blob/951cf82c120d4069e940e832db03bfa018c688ea/libs/cluster/Server/Migration/MigrateSessionKeys.cs#L146-L169" class="githubLink" style="margin:0 10px" target="_blank">View on GitHub</a></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrate-slots-details">Migrate SLOTS Details<a href="#migrate-slots-details" class="hash-link" aria-label="Direct link to Migrate SLOTS Details" title="Direct link to Migrate SLOTS Details">​</a></h2>
<p>The <code>SLOTS</code> or <code>SLOTSRANGE</code> options enables Garnet to migrate a collection of slots and all the associated keys mapping to these slots.
These options differ from the <code>KEYS</code> options in the following ways:</p>
<ol>
<li>There is no need to have specific knowledge of the individual keys that are being migrated and how they map to the associated slots. The user simply needs to provide just a slot number.</li>
<li>State transitions are handled entirely on the server side.</li>
<li>For the migration operation to complete, we have to scan both main and object stores to find and migrate all keys associated with a given slot.</li>
</ol>
<p>It might seem, based on the last bullet point from above that the migration operation using <code>SLOTS</code> or <code>SLOTSRANGE</code> is more expensive, especially if the slot that is being migrated contains only a few keys.
However, it is generally less expensive compared to the <code>KEYS</code> option which requires multiple roundtrips between client and server (so any relevant keys can be used as input to the <code>MIGRATE</code> command), in addition to having to perform a full scan of both stores.</p>
<p>As shown in the code excerpt below, the <code>MIGRATE SLOTS</code> task will safely transition the state of a slot in the remote node config to <code>IMPORTING</code> and the slot state of the local node config to <code>MIGRATING</code>, by relying on the epoch protection mechanism as described previously.
Following, it will start migrating the data to the target node in batches.
On completion of data migration, the task will conclude with performing next slot state transition where ownership of the slots being migrates will be handed to the target node.
The slot ownership exchange becomes visible to the whole cluster by bumping the local node&#x27;s configuration epoch (i.e. using RelinquishOwnership command).
Finally, the source node will issue <code>CLUSTER SETSLOT NODE</code> to the target node to explicitly make it an owner of the corresponding slot collection.
This last step is not necessary and it is used only to speed up the config propagation.</p>
<div class="docusaurus-theme-github-codeblock"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MigrateSlots Background Task</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">loading</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:right;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/microsoft/garnet/blob/951cf82c120d4069e940e832db03bfa018c688ea/libs/cluster/Server/Migration/MigrationDriver.cs#L54-L126" class="githubLink" style="margin:0 10px" target="_blank">View on GitHub</a></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/microsoft/garnet/tree/main/website/docs/dev/cluster/migration.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/garnet/docs/dev/cluster/sharding"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Sharding</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/garnet/docs/dev/contributing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Contributing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#migration-data-integrity" class="table-of-contents__link toc-highlight">Migration Data Integrity</a></li><li><a href="#migrate-keys-implementation-details" class="table-of-contents__link toc-highlight">Migrate KEYS Implementation Details</a></li><li><a href="#migrate-slots-details" class="table-of-contents__link toc-highlight">Migrate SLOTS Details</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/docs/getting-started">Getting Started</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://aka.ms/garnet-discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/msrgarnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p class="text-center">
          <a href="https://go.microsoft.com/fwlink/?LinkId=521839" style="color: white;">Privacy &amp; Cookies</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=2259814" style="color: white;">Consumer Health Privacy</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=206977" style="color: white;">Terms of Use</a> |
          <a href="https://www.microsoft.com/trademarks" style="color: white;">Trademarks</a> | © 2025
          </p></div></div></div></footer></div>
</body>
</html>