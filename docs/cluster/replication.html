<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-cluster/replication" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Replication | Garnet</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/garnet/docs/cluster/replication"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Replication | Garnet"><meta data-rh="true" name="description" content="Garnet cluster support asynchronous replication following a simple leader-follower (i.e. primary-replica) model."><meta data-rh="true" property="og:description" content="Garnet cluster support asynchronous replication following a simple leader-follower (i.e. primary-replica) model."><link data-rh="true" rel="icon" href="/garnet/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/garnet/docs/cluster/replication"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/cluster/replication" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/cluster/replication" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Replication","item":"https://microsoft.github.io/garnet/docs/cluster/replication"}]}</script><link rel="alternate" type="application/rss+xml" href="/garnet/blog/rss.xml" title="Garnet RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/garnet/blog/atom.xml" title="Garnet Atom Feed">




<script>!function(t,e,n,c,a,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/loh6v65ww5",(s=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/garnet/assets/css/styles.b16fc56b.css">
<script src="/garnet/assets/js/runtime~main.5e97eeaf.js" defer="defer"></script>
<script src="/garnet/assets/js/main.a9bb9d6c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/garnet/"><div class="navbar__logo"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Garnet</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/garnet/docs">Docs</a><a class="navbar__item navbar__link" href="/garnet/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/garnet/docs">Welcome</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/news">News</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/features">Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/releases">Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/compatibility">Compatibility</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/about-us">About Us</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/getting-started">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/benchmarking/overview">Benchmarking</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/commands/overview">Commands</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/extensions/overview">Server Extensions</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/garnet/docs/cluster/overview">Cluster Mode</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/cluster/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/garnet/docs/cluster/replication">Replication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/cluster/key-migration">Key Migration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/dev/onboarding">Developer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/garnet/docs/research/papers">Research</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="https://github.com/microsoft/garnet/releases" target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false">Other Links</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/garnet/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Cluster Mode</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Replication</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Garnet Cluster Replication</h1></header>
<p>Garnet cluster support asynchronous replication following a simple leader-follower (i.e. primary-replica) model.
This allows the replica to be exact copies of the primary.
Replication can be leveraged to scale reads and mitigate the effects of primary failures by promoting replicas to primary.
In this page, we present an overview of the replication protocol and discuss the different persistent/consistency options available to the cluster operator.</p>
<h1>Garnet Replication Properties</h1>
<p>Garnet cluster implements replication through log shipping.
Primaries utilize the Append-Only-File (AOF) to record insert/update operations.
A dedicated background task iterates through the log pages and transmits them in bulk to the corresponding replica.
Replicas will iterate through the received log pages, replay all insert/update operations in order, and generate their own AOF.
Primaries are generally free to take arbitrary checkpoints.
When the primary takes a checkpoint, it will insert a checkpoint marker into the AOF.
As a side effect of this, when any of the attached replicas receive the corresponding records, it will initiate its own checkpoint.
For this reason, an exact version of the data is identified from the following triplet:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[replication-id, checkpoint-version, replication-offset]</span><br></span></code></pre></div></div>
<p>Allowing replicas to take their own checkpoints speeds up the recovery process because in the common case replicas can recover from their own checkpoint and replay their AOF before connecting to their primary and resuming synchronization.
On rare occasions, the replica must perform a full synchronization by retrieving the latest checkpoint from the primary.
Partial synchronization involves recovering from a local checkpoint (if any) and replaying only the primary&#x27;s AOF log after the corresponding Checkpoint Covered Replication Offset (CCRO).
Full synchronization involves retrieving the latest primary checkpoint and recovering from it before starting to accept any new AOF log records.</p>
<p>The replica decides if it will perform either type of synchronization as follows:</p>
<ol>
<li>If the primary replication-id differs from the replica replication-id, a full synchronization must occur.</li>
<li>If the primary checkpoint version differs from the replica checkpoint, a full synchronization must occur.</li>
<li>If none of the above conditions are true, replica can recover from local checkpoint and then continue replaying from the AOF offsets that is missing.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replication-performance-vs-durability-options">Replication Performance vs Durability Options<a href="#replication-performance-vs-durability-options" class="hash-link" aria-label="Direct link to Replication Performance vs Durability Options" title="Direct link to Replication Performance vs Durability Options">​</a></h2>
<p>Under normal workload the AOF log will keep growing with every insert/update operation until a checkpoint is taken.
Newly added AOF log records will initially reside in memory and then flushed to disk as new records are being added.
For write heavye workloads, this could severely impact query performance at the primary.
In addition, newly configured replicas, added to the cluster, could face longer synchronization times since they have to replay the AOF log records starting from the corresponding CCRO.</p>
<p>The cluster operator can choose between various replication options to achieve a trade-off between performance and durability.
A summary of these options is shown below:</p>
<ul>
<li>Fast AOF Truncation (FAT)
This option forces the primary to aggressively truncate the AOF so it does not spill into disk. It can be used in combination with aof-memory option which determines the maximum AOF memory buffer size.
When a replica attaches to a primary with FAT turned on, the AOF is not guaranteed to be truncated which may result in writes being lost.
To overcome this issue FAT should be used with ODC.</li>
<li>On Demand Checkpoint (ODC)
This option forces the primary to take a checkpoint if no checkpoint is available when replica tries to attach and recover. If a checkpoint becomes or was availalbe and the CCRO has not been truncated, then
the primary will lock it to prevent truncation while a replica is recovering. In this case, they AOF log could spill to disk as the AOF in memory buffer becomes full.
Under normal operation, the AOF is truncated and no spilling to disk will happen.</li>
</ul>
<p>Using the aforementioned options, we guarantee that no writes are lost while a replica is attaching and replication remains highly performant.
However, due to the asynchronous nature of replication, if a primary goes down before unexpectedly, the replicas might have not received the latest AOF log records, resulting in lost writes.</p>
<h1>Creating a Garnet Cluster with Replication</h1>
<p>The process of setting up a cluster with replication is similar to setting up a regular cluster while also enabling the aof option.
This should done for every instance in the cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GarnetServer.exe --cluster --checkpointdir=&#x27;data/&#x27; --aof</span><br></span></code></pre></div></div>
<p>The AOF log file is stored within the checkpointdir folder which by default is the working folder.
By default every Garnet instance will take the role of an empty primary.
The cluster operator has to initially assign the slots to a subset of those primaries.
The rest of the instances can be coverted to replicas by using the <code>CLUSTER REPLICATE</code> command.
An example of setting up a cluster with a single primary and 2 replicas is shown below:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7000 cluster myid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;15373cf386c5090a5f8a25f819c96b04a756381c&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7000 cluster addslotsrange 0 16383</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7000 cluster set-config-epoch 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7001 cluster set-config-epoch 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7002 cluster set-config-epoch 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7000 cluster meet 192.168.1.26 7001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7000 cluster meet 192.168.1.26 7002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7001 cluster replicate 15373cf386c5090a5f8a25f819c96b04a756381c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7002 cluster replicate 15373cf386c5090a5f8a25f819c96b04a756381c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7000 cluster nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15373cf386c5090a5f8a25f819c96b04a756381c 192.168.1.26:7000@17000,DESKTOP-BT8KHK1 myself,master - 0 0 1 connected 0-16383</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5868649e4205bf6ea97e4b7a12f101c3aed96b71 192.168.1.26:7001@17001,DESKTOP-BT8KHK1 slave 15373cf386c5090a5f8a25f819c96b04a756381c 0 0 4 connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">947692ec7fb4a919ae7d0d7e314e9dcbcbd99774 192.168.1.26:7002@17002,DESKTOP-BT8KHK1 slave 15373cf386c5090a5f8a25f819c96b04a756381c 0 0 5 connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7001 cluster nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5868649e4205bf6ea97e4b7a12f101c3aed96b71 192.168.1.26:7001@17001,DESKTOP-BT8KHK1 myself,slave 15373cf386c5090a5f8a25f819c96b04a756381c 0 0 4 connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15373cf386c5090a5f8a25f819c96b04a756381c 192.168.1.26:7000@17000,DESKTOP-BT8KHK1 master - 0 0 1 connected 0-16383</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">947692ec7fb4a919ae7d0d7e314e9dcbcbd99774 192.168.1.26:7002@17002,DESKTOP-BT8KHK1 slave 15373cf386c5090a5f8a25f819c96b04a756381c 0 0 5 connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7002 cluster nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">947692ec7fb4a919ae7d0d7e314e9dcbcbd99774 192.168.1.26:7002@17002,DESKTOP-BT8KHK1 myself,slave 15373cf386c5090a5f8a25f819c96b04a756381c 0 0 5 connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15373cf386c5090a5f8a25f819c96b04a756381c 192.168.1.26:7000@17000,DESKTOP-BT8KHK1 master - 0 0 1 connected 0-16383</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5868649e4205bf6ea97e4b7a12f101c3aed96b71 192.168.1.26:7001@17001,DESKTOP-BT8KHK1 slave 15373cf386c5090a5f8a25f819c96b04a756381c 0 0 4 connected</span><br></span></code></pre></div></div>
<p>There is not limit on the number of replicas attached to a given primary.
Currently, we do not support chained replication.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="querying-a-replica">Querying a Replica<a href="#querying-a-replica" class="hash-link" aria-label="Direct link to Querying a Replica" title="Direct link to Querying a Replica">​</a></h2>
<p>By default replicas only serve read queries but can also be configure to process write requests.
This option is available by issuing once <code>READWRITE</code> command just before executing any write operation in a single client session.
Issuing <code>READONLY</code> will toggle back to serving read queries.</p>
<p>If a replica is set to process read-only queries, it will respond with <em>-MOVED</em> to any write requests, redirecting them to the primary that is replicating.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7001 -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7001&gt; set x 1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-&gt; Redirected to slot [16287] located at 192.168.1.26:7000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; set x 1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; get x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1234&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7001 -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7001&gt; get x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1234&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7001&gt; exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7002&gt; get x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1234&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="checkpointing--recovery">Checkpointing &amp; Recovery<a href="#checkpointing--recovery" class="hash-link" aria-label="Direct link to Checkpointing &amp; Recovery" title="Direct link to Checkpointing &amp; Recovery">​</a></h2>
<p>As noted above primaries can take arbirtrary checkpoints and propagate that information to the replicas.
Replicas will identify the checkpoint record in the AOF file and initiate a checkpoint on its own.
Taking a checkpoint at the primary is as easy as calling <code>SAVE</code> or <code>BGSAVE</code>command.
When the checkpoint operation completes, it is recorded into the AOF log.
The replicas will receive that record and initiate its own checkpoint.</p>
<p>An example of checkpoint propagation is shown below:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; lastsave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; bgsave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Background saving started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; lastsave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 1706555027</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7001&gt; lastsave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 1706555029</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7001&gt; exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7002&gt; lastsave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 1706555028</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7002&gt;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replication-information">Replication Information<a href="#replication-information" class="hash-link" aria-label="Direct link to Replication Information" title="Direct link to Replication Information">​</a></h2>
<p>The system admin can track the progress of replication by retrieving the replication information section using info replication command.
A summary of the available fields returned is shown below:</p>
<p>role: role of the instance being queried
connected_slaves: number of replicas connected to the instance.
master_failover_state:  The state of an ongoing failover, if any.
master_replid: replication id of this Garnet server instance.
master_replid2: secondary replication id (currently not being used).
master_repl_offset: current primary AOF offset.
store_current_safe_aof_address: AOF address covered by latest checkpoint
store_recovered_safe_aof_address:  AOF address covered by the recovered checkpoint
object_store_current_safe_aof_address: AOF address covered by latest checkpoint of object store
object_store_recovered_safe_aof_address: AOF address covered by recovered checkpoint of object store</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; info replication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Replication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">role:master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected_slaves:2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_failover_state:no-failover</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_replid:dd194cb04b18b31373157e22d0ab36df9cc6a04a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_replid2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_repl_offset:136</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">second_repl_offset:136</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store_current_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store_recovered_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object_store_current_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object_store_recovered_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave0:ip=192.168.1.26,port=7001,state=online,offset=136,lag=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave1:ip=192.168.1.26,port=7002,state=online,offset=136,lag=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7000&gt; exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Dev&gt; redis-cli -h 192.168.1.26 -p 7001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7001&gt; info replication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Replication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">role:slave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected_slaves:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_failover_state:no-failover</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_replid:dd194cb04b18b31373157e22d0ab36df9cc6a04a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_replid2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_repl_offset:136</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">second_repl_offset:136</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store_current_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store_recovered_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object_store_current_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object_store_recovered_safe_aof_address:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_host:192.168.1.26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_port:7000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_link_status:up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_last_io_seconds_ago:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_sync_in_progress:False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave_read_repl_offset:136</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave_priority:100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave_read_only:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replica_announced:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.26:7001&gt;</span><br></span></code></pre></div></div>
<h1>Diskless Replication</h1>
<p>When AOF gets truncated, full synchronization requires taking a checkpoint and sending that checkpoint over to the attaching replica.
This operation can be expensive because it involves multiple I/O operations at the primary and replica.
For this reason, we added a variant of full synchronization called diskless replication.
This is implemented using a streaming checkpoint that allows clients to continue issuing read and writes at the primary while attaching replicas synchronize.
To enable diskless replication the server needs to be started with the following flags</p>
<p>--repl-diskless-sync=true
This is used to enable diskless replication</p>
<p>--repl-diskless-sync-delay=&lt;seconds&gt;.
This is used to determine how many seconds to wait before starting the full sync, in order to give the opportunity to multiple replicas to attach and receive the streaming checkpoint.</p>
<p>There is no additional requirements to that of using the aforementioned flags in order to leverage diskless replication.
The APIs for mapping replicas remain the same (i.e. CLUSTER REPLICATE, REPLICAOF etc.).</p>
<p>Note that diskless replication does not take an actual checkpoint.
Hence every time a full sync is performed, the AOF is not automatically truncated (unless FAT flag is used).
This happens to ensure durability in the event of a failure which will not be possible if the AOF gets truncated without a persistent checkpoint.
However, the store version gets incremented to ensure consistency across different instances that may be fully synced at different times.
Users can still utilize SAVE/BGSAVE commands or --aof-size-limit to periodically take a checkpoint and safely truncates the AOF.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/microsoft/garnet/tree/main/website/docs/cluster/replication.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/garnet/docs/cluster/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/garnet/docs/cluster/key-migration"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Key Migration</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#replication-performance-vs-durability-options" class="table-of-contents__link toc-highlight">Replication Performance vs Durability Options</a></li><li><a href="#querying-a-replica" class="table-of-contents__link toc-highlight">Querying a Replica</a></li><li><a href="#checkpointing--recovery" class="table-of-contents__link toc-highlight">Checkpointing &amp; Recovery</a></li><li><a href="#replication-information" class="table-of-contents__link toc-highlight">Replication Information</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/docs/getting-started">Getting Started</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://aka.ms/garnet-discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/msrgarnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p class="text-center">
          <a href="https://go.microsoft.com/fwlink/?LinkId=521839" style="color: white;">Privacy &amp; Cookies</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=2259814" style="color: white;">Consumer Health Privacy</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=206977" style="color: white;">Terms of Use</a> |
          <a href="https://www.microsoft.com/trademarks" style="color: white;">Trademarks</a> | © 2025
          </p></div></div></div></footer></div>
</body>
</html>