<!doctype html>
<html lang="en" data-bs-theme="auto">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Benchmarks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.2/dist/Chart.min.js"></script>
</head>

<body>
    <header class="d-flex flex-wrap justify-content-between py-3 mb-4 px-3 border-bottom">
        <a href="https://microsoft.github.io/garnet" class="d-flex align-items-center mb-md-0 me-md-auto link-body-emphasis text-decoration-none" target="_blank">
            <img src="https://microsoft.github.io/garnet/img/garnet-logo-diamond.png" class="me-2"
                 style="width: 40px; height: 40px;" alt="Garnet Logo">
            <span class="fs-4">Garnet Benchmarks</span>
        </a>

        <div class="text-end d-flex align-items-center">
            <button type="button" class="btn btn-outline-secondary me-2" id="dl-button">
                <i class="bi bi-file-earmark-arrow-down"></i>
                Download JSON Data
            </button>
            <a class="btn btn-secondary" id="repository-link" href="#" target="_blank" role="button">
                <i class="bi bi-github"></i> GitHub
            </a>
        </div>
    </header>
    <main class="container px-4" style="max-width: 960px;">
        <!-- Selectors -->
        <form class="row g-2 mb-4">
            <div class="col-sm-8">
                <select class="form-select" title="Select Benchmark set" id="benchmark-set-selector">
                    <option value="featured" selected>Featured Benchmarks</option>
                </select>
            </div>
            <div class="col-sm-2">
                <select class="form-select" title="Select Benchmark Type" id="benchmark-type-selector">
                    <option value="type" selected>Type</option>
                </select>
            </div>

            <div class="col-sm-2">
                <select class="form-select" title="Select Benchmark OS" id="benchmark-os-selector">
                    <option value="ALL" selected>OS</option>
                    <option value="UBUNTU">Ubuntu</option>
                    <option value="WINDOWS">Windows</option>
                </select>
            </div>
            <div class="col-sm-12">
                <select class="form-select" title="Select Benchmark" id="benchmark-selector">
                    <option value="select-benchmark" selected>Select Benchmark</option>
                </select>
            </div>
        </form>

        <!-- Benchmarks -->
        <div id="benchmarks-container"></div>
        <br><br><br><br><br>
    </main>

    <footer class="footer d-flex p-3 flex-wrap justify-content-between align-items-center border-top fixed-bottom"
        style="background-color: var(--bs-body-bg);">
        <div>
            <small class="text-body-secondary">Last update:</small>
            <span class="badge text-bg-secondary" id="last-update"></span>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle d-none" id="scroll-to-top-button"
            title="Scroll to top" onclick="scrollToTop()">
            <i class="bi bi-arrow-up"></i>
        </button>
        <small class="text-body-secondary">Powered by <a rel="noopener" target="_blank"
                href="https://github.com/marketplace/actions/continuous-benchmark">github-action-benchmark</a></small>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        let button = document.getElementById("scroll-to-top-button");

        window.onscroll = function () {
            onScroll();
        };

        function onScroll() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                button.classList.remove("d-none");
            } else {
                button.classList.add("d-none");
            }
        }

        function scrollToTop() {
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }
    </script>
    <script>
        // Automatic light/dark mode support
        const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const theme = darkModeMediaQuery.matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-bs-theme', theme);

        darkModeMediaQuery.addListener((e) => {
            const theme = e.matches ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
        });
    </script>
    <script src="data.js"></script>
    <script id="main-script">
        'use strict';
        (function () {
            // Colors from https://github.com/github/linguist/blob/master/lib/linguist/languages.yml
            const toolColors = {
                cargo: '#dea584',
                go: '#00add8',
                benchmarkjs: '#f1e05a',
                benchmarkluau: '#000080',
                pytest: '#3572a5',
                googlecpp: '#f34b7d',
                catch2: '#f34b7d',
                julia: '#a270ba',
                jmh: '#b07219',
                benchmarkdotnet: '#178600',
                customBiggerIsBetter: '#38ff38',
                customSmallerIsBetter: '#ff3838',
                _: '#333333'
            };

            const FEATURED_BENCHMARKS = Object.freeze([
                'Operations.BasicOperations.InlinePing(Params: None)',
                'Operations.RawStringOperations.Set(Params: None)',
                'Operations.RawStringOperations.GetFound(Params: None)',
                'Operations.RawStringOperations.GetNotFound(Params: None)',
                'Operations.RawStringOperations.Increment(Params: None)',
                'Operations.RawStringOperations.IncrementBy(Params: None)',
                'Network.BasicOperations.InlinePing(Params: None)',
                'Network.RawStringOperations.Set(Params: None)',
                'Network.RawStringOperations.GetFound(Params: None)',
                'Network.RawStringOperations.GetNotFound(Params: None)',
                'Network.RawStringOperations.Increment(Params: None)',
                'Network.RawStringOperations.IncrementBy(Params: None)',
                'Operations.ObjectOperations.ZAddRem(Params: None)',
                'Operations.ObjectOperations.LPushPop(Params: None)',
                'Lua.LuaScripts.Script3(Params: Managed,None)',
            ]).map(str => str.toLowerCase());;

            const VIEW_TYPE = Object.freeze({
                FEATURED: "FEATURED",
                SELECTED: "SELECTED"
            });

            const OS_TYPE = Object.freeze({
                ALL: "ALL",
                UBUNTU: "UBUNTU",
                WINDOWS: "WINDOWS"
            });

            var CURRENT_VIEW_TYPE = VIEW_TYPE.FEATURED;
            var SELECTED_BENCHMARK_TYPE = undefined;
            var SELECTED_OS = OS_TYPE.ALL;
            var SELECTED_BENCHMARK_SET = undefined;

            function init() {
                function collectBenchesPerTestCase(entries) {
                    const map = new Map();
                    for (const entry of entries) {
                        const { commit, date, tool, benches } = entry;
                        for (const bench of benches) {
                            const result = { commit, date, tool, bench };
                            const arr = map.get(bench.name);
                            if (arr === undefined) {
                                map.set(bench.name, [result]);
                            } else {
                                arr.push(result);
                            }
                        }
                    }
                    // Sort entries by name
                    const sortedMap = new Map([...map.entries()].sort((a, b) => a[0].localeCompare(b[0])));
                    return sortedMap;
                }

                const data = window.BENCHMARK_DATA;
                delete data.entries.Benchmark;

                // Render header
                const dateFormatter = new Intl.DateTimeFormat(navigator.language, {
                    year: 'numeric',
                    month: 'numeric',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                })
                const date = dateFormatter.format(new Date(data.lastUpdate));
                document.getElementById('last-update').textContent = date;

                const repoLink = document.getElementById('repository-link');
                repoLink.href = data.repoUrl;

                // Render footer
                document.getElementById('dl-button').onclick = () => {
                    const dataStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "benchmark_data.json";
                    document.body.appendChild(a);
                    a.click();

                    // Clean up
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                // Prepare data points for charts
                const dataSets = Object.keys(data.entries).map(name => ({
                    name,
                    dataSet: collectBenchesPerTestCase(data.entries[name]),
                }));
                // Sort data sets by name
                dataSets.sort((a, b) => a.name.localeCompare(b.name));
                return dataSets;
            }

            function renderAllCharts(dataSets) {

                function renderGraph(parent, name, dataset) {
                    const canvas = document.createElement('canvas');
                    canvas.setAttribute('data-graph-name', name);
                    parent.appendChild(canvas);

                    const color = toolColors[dataset.length > 0 ? dataset[0].tool : '_'];
                    const data = {
                        labels: dataset.map(d => d.commit.id.slice(0, 7)),
                        datasets: [
                            {
                                label: name,
                                data: dataset.map(d => d.bench.value),
                                borderColor: color,
                                backgroundColor: color + '60', // Add alpha for #rrggbbaa
                            }
                        ],
                    };
                    const options = {
                        scales: {
                            xAxes: [
                                {
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'commit',
                                    },
                                }
                            ],
                            yAxes: [
                                {
                                    scaleLabel: {
                                        display: true,
                                        labelString: dataset.length > 0 ? dataset[0].bench.unit : '',
                                    },
                                    ticks: {
                                        beginAtZero: true,
                                    }
                                }
                            ],
                        },
                        tooltips: {
                            callbacks: {
                                afterTitle: items => {
                                    const { index } = items[0];
                                    const data = dataset[index];
                                    return '\n' + data.commit.message + '\n\n' + data.commit.timestamp + ' committed by @' + data.commit.committer.username + '\n';
                                },
                                label: item => {
                                    let label = item.value;
                                    const { range, unit } = dataset[item.index].bench;
                                    label += ' ' + unit;
                                    if (range) {
                                        label += ' (' + range + ')';
                                    }
                                    return label;
                                },
                                afterLabel: item => {
                                    const { extra } = dataset[item.index].bench;
                                    return extra ? '\n' + extra : '';
                                }
                            }
                        },
                        onClick: (_mouseEvent, activeElems) => {
                            if (activeElems.length === 0) {
                                return;
                            }
                            // XXX: Undocumented. How can we know the index?
                            const index = activeElems[0]._index;
                            const url = dataset[index].commit.url;
                            window.open(url, '_blank');
                        },
                    };

                    new Chart(canvas, {
                        type: 'line',
                        data,
                        options,
                    });
                }

                function renderBenchSet(name, benchSet, main) {
                    const setElem = document.createElement('div');
                    setElem.className = 'mb-3';
                    setElem.id = 'benchmark-set-' + name;
                    main.appendChild(setElem);

                    const nameElem = document.createElement('h4');
                    nameElem.className = 'text-center mb-3';
                    nameElem.textContent = name;
                    setElem.appendChild(nameElem);

                    const graphsElem = document.createElement('div');
                    graphsElem.className = 'vstack gap-3';
                    setElem.appendChild(graphsElem);

                    for (const [benchName, benches] of benchSet.entries()) {
                        if (CURRENT_VIEW_TYPE === VIEW_TYPE.FEATURED &&
                            !FEATURED_BENCHMARKS.some(val => benchName.toLowerCase().includes(val.toLowerCase()))) {
                            continue;
                        }

                        renderGraph(graphsElem, benchName, benches)
                    }
                }

                const chartsContainer = document.getElementById('benchmarks-container');
                chartsContainer.innerHTML = '';

                switch (CURRENT_VIEW_TYPE) {
                    case VIEW_TYPE.FEATURED: {
                        var didRender = false;

                        const featuredDataSets = featuredDatasets(dataSets, FEATURED_BENCHMARKS);
                        for (const featuredDataSetName of featuredDataSets.keys()) {
                            const dataSet = dataSets.find(ds => ds.name === featuredDataSetName);
                            if (shouldShowBenchmarkSet(dataSet.name)) {
                                didRender = true;
                                renderBenchSet(dataSet.name, dataSet.dataSet, chartsContainer);
                            }
                        }
                        if (!didRender) {
                            const chartsContainer = document.getElementById('benchmarks-container');
                            chartsContainer.innerHTML = '<div class="px-4 py-5 my-5 text-center"> <p class="mb-4">No benchmarks match your selected filters. Try adjusting your filter settings.</p> </div>';
                        }
                    } break;
                    case VIEW_TYPE.SELECTED: {
                        for (const { name, dataSet } of dataSets) {
                            if (name === SELECTED_BENCHMARK_SET) {
                                renderBenchSet(name, dataSet, chartsContainer);
                            }
                        }
                    } break;
                }
            }

            function featuredDatasets(datasets, featuredBenchmarks) {
                const featuredDatasets = new Map();

                // Make sure the order of the featured benchmarks is preserved
                for (const featuredBenchmark of featuredBenchmarks) {
                    for (const { name, dataSet } of dataSets) {
                        for (const benchName of dataSet.keys()) {
                            if (benchName.toLowerCase().includes(featuredBenchmark)) {
                                if (featuredDatasets.has(name)) {
                                    featuredDatasets.get(name).push(benchName);
                                } else {
                                    featuredDatasets.set(name, [benchName]);
                                }
                            }
                        }
                    }
                }

                return featuredDatasets;
            }

            function populateBenchmarkSetSelector(dataSets) {
                const selector = document.getElementById('benchmark-set-selector');
                selector.innerHTML = '<option value="featured" selected>Featured Benchmarks</option>';

                dataSets.forEach(({ name }) => {
                    if (shouldShowBenchmarkSet(name)) {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selector.appendChild(option);
                    }
                });
            }

            function populateBenchmarkSelector(dataSets) {
                const selector = document.getElementById('benchmark-selector');
                selector.innerHTML = '<option selected>Select Benchmark</option>';

                switch (CURRENT_VIEW_TYPE) {
                    case VIEW_TYPE.FEATURED: {
                        const featuredDataSets = featuredDatasets(dataSets, FEATURED_BENCHMARKS);

                        for (const [name, benches] of featuredDataSets.entries()) {
                            if (!shouldShowBenchmarkSet(name)) {
                                continue;
                            }

                            const optgroup = document.createElement('optgroup');
                            optgroup.label = name;
                            selector.appendChild(optgroup);

                            for (const benchName of benches) {
                                const option = document.createElement('option');
                                option.value = benchName;
                                option.textContent = benchName;
                                optgroup.appendChild(option);
                            }
                        }
                    } break;
                    case VIEW_TYPE.SELECTED: {
                        const selectedDataSet = dataSets.find(ds => ds.name === SELECTED_BENCHMARK_SET);
                        if (selectedDataSet) {
                            for (const benchName of selectedDataSet.dataSet.keys()) {
                                const option = document.createElement('option');
                                option.value = benchName;
                                option.textContent = benchName;
                                selector.appendChild(option);
                            }
                        }
                    } break;
                }
            }

            function populateBenchmarkTypeSelector(benchmarkTypes) {
                const selector = document.getElementById('benchmark-type-selector');
                selector.innerHTML = '<option value="type" selected>Type</option>';

                benchmarkTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selector.appendChild(option);
                });
            }

            function shouldShowBenchmarkSet(name) {
                var osMatch = true;
                switch (SELECTED_OS) {
                    case OS_TYPE.ALL:
                        osMatch = true;
                        break;
                    case OS_TYPE.UBUNTU:
                        osMatch = name.toLowerCase().includes('ubuntu');
                        break;
                    case OS_TYPE.WINDOWS:
                        osMatch = name.toLowerCase().includes('windows');
                        break;
                }

                const typeMatch = SELECTED_BENCHMARK_TYPE ? name.toLowerCase().startsWith(SELECTED_BENCHMARK_TYPE.toLowerCase()) : true;

                return osMatch && typeMatch;
            }

            function resetBenchmarks() {
                CURRENT_VIEW_TYPE = VIEW_TYPE.FEATURED;
                SELECTED_BENCHMARK_SET = undefined;

                populateBenchmarkSetSelector(dataSets);
                populateBenchmarkSelector(dataSets);
                renderAllCharts(dataSets);
            }

            const dataSets = init();

            populateBenchmarkSetSelector(dataSets);
            populateBenchmarkSelector(dataSets);

            // Get unique benchmark types
            const benchmarkTypes = dataSets.map(ds => ds.name.split('.')[0])
                .filter((value, index, self) => self.indexOf(value) === index);
            populateBenchmarkTypeSelector(benchmarkTypes);

            renderAllCharts(dataSets, SELECTED_BENCHMARK_SET);

            document.getElementById('benchmark-set-selector').addEventListener('change', function () {
                if (this.value === 'featured') {
                    CURRENT_VIEW_TYPE = VIEW_TYPE.FEATURED;
                    SELECTED_BENCHMARK_SET = undefined;
                } else {
                    CURRENT_VIEW_TYPE = VIEW_TYPE.SELECTED;
                    SELECTED_BENCHMARK_SET = this.value;
                }

                renderAllCharts(dataSets);
                populateBenchmarkSelector(dataSets);
            });

            document.getElementById('benchmark-selector').addEventListener('change', function () {
                if (this.value === 'select-benchmark') {
                    return;
                }

                const targetElement = document.querySelector(`[data-graph-name="${this.value}"]`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });

            document.getElementById('benchmark-type-selector').addEventListener('change', function () {
                SELECTED_BENCHMARK_TYPE = this.value === 'type' ? undefined : this.value;
                resetBenchmarks()
            });

            document.getElementById('benchmark-os-selector').addEventListener('change', function () {
                SELECTED_OS = this.value;
                resetBenchmarks()
            });
        })();
    </script>
</body>

</html>
